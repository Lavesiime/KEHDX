//------------Sonic CD Sonic Script-------------//
//--------Scripted by Christian Whitehead 'The Taxman'--------//
//-------Unpacked By Rubberduckycooly's Script Unpacker-------//

//-------Aliases-------//
#alias 7: TYPE_SONIC
public alias  arrayPos6 : currentPlayer
public alias  arrayPos7 : playerCount

public alias Object.Value7:Player.Tilt

function Sonic_ProcessPlayer
	if Options.AttractMode==false
#platform: Mobile
		if Options.TouchControls==1
			if object.controlMode==0
				CheckTouchRect(0,96,screen.xcenter,Screen.YSize)
				if CheckResult>-1
					ArrayPos0=CheckResult
					temp0=TouchScreen[ArrayPos0].XPos
					temp0-=Options.DPadX
					temp1=TouchScreen[ArrayPos0].YPos
					temp1-=192
					ATan2(temp2,temp0,temp1)
					temp2+=32
					temp2&=255
					temp2>>=6
					switch temp2
					case 0
						inputDown.right=1
						break
					case 1
						inputDown.down=1
						break
					case 2
						inputDown.left=1
						break
					case 3
						inputDown.up=1
						break
					endswitch
				endif
				CheckTouchRect(screen.xcenter,166,Screen.XSize,240)
				if CheckResult>-1
					KeyDown.ButtonA=1
				endif
				if Object[25].Value7==0
					KeyPress.ButtonA|=KeyDown.ButtonA
				endif
				Object[25].Value7=KeyDown.ButtonA
				if Object[9].Type==TypeName[BlankObject]
					CheckTouchRect(240,0,Screen.XSize,40)
					if CheckResult>-1
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						if Engine.FrameSkipTimer>-1
							Engine.FrameSkipTimer=-1
						endif
						TileLayer[0].Type=3
					endif
					if Engine.Message==2
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						if Engine.FrameSkipTimer>-1
							Engine.FrameSkipTimer=-1
						endif
						TileLayer[0].Type=3
					endif
				endif
			endif
		else
			if object.controlMode==0
				if Object[9].Type==TypeName[BlankObject]
					if KeyPress.Start==1
						KeyPress.Start=0
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						if Engine.FrameSkipTimer>-1
							Engine.FrameSkipTimer=-1
						endif
						TileLayer[0].Type=3
					endif
					if Engine.Message==2
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						if Engine.FrameSkipTimer>-1
							Engine.FrameSkipTimer=-1
						endif
						TileLayer[0].Type=3
					endif
				endif
			endif
		endif
#endplatform
#platform: Standard
		if object.controlMode==0
			if Object[9].Type==TypeName[BlankObject]
				if KeyPress.Start==true
					KeyPress.Start=false
					if Options.DevMenuFlag==true
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						TileLayer[0].Type=3
					else
						EngineCallback(13)
					endif
				endif
			endif
		endif
#endplatform
		ProcessObjectControl()
	endif
end function


function Sonic_HandlePause
	if Options.AttractMode==false
#platform: Mobile
		if object.controlMode==0
			if Object[9].Type==TypeName[BlankObject]
				CheckTouchRect(240,0,Screen.XSize,40)
				if CheckResult>-1
					Stage.State=STAGE_PAUSED
					PauseMusic()
					PlaySfx(27,0)
					StopSfx(24)
					StopSfx(25)
					Object[9].Type=TypeName[PauseMenu]
					Object[9].DrawOrder=6
					Object[9].Priority=2
					if Engine.FrameSkipTimer>-1
						Engine.FrameSkipTimer=-1
					endif
					TileLayer[0].Type=3
				endif
				if Engine.Message==2
					Stage.State=STAGE_PAUSED
					PauseMusic()
					PlaySfx(27,0)
					StopSfx(24)
					StopSfx(25)
					Object[9].Type=TypeName[PauseMenu]
					Object[9].DrawOrder=6
					Object[9].Priority=2
					if Engine.FrameSkipTimer>-1
						Engine.FrameSkipTimer=-1
					endif
					TileLayer[0].Type=3
				endif
			endif
		endif
#endplatform

#platform: Standard
		if object.controlMode==0
			if Object[9].Type==TypeName[BlankObject]
				if KeyPress.Start==true
					KeyPress.Start=false
					if Options.DevMenuFlag==true
						Stage.State=STAGE_PAUSED
						PauseMusic()
						PlaySfx(27,0)
						StopSfx(24)
						StopSfx(25)
						Object[9].Type=TypeName[PauseMenu]
						Object[9].DrawOrder=6
						Object[9].Priority=2
						TileLayer[0].Type=3
					else
						EngineCallback(13)
					endif
				endif
			endif
		endif
#endplatform
	endif
end function


function Sonic_HandlePlayerTilt
	if object.left==1
		Player.Tilt--
		if Player.Tilt<-8
			Player.Tilt=-8
		endif
	else
		if object.right==1
			Player.Tilt++
			if Player.Tilt>8
				Player.Tilt=8
			endif
		else
			if Player.Tilt>0
				Player.Tilt--
			endif
			if Player.Tilt<0
				Player.Tilt++
			endif
		endif
	endif
	if object.left==1
		object.angle+=2
	endif
	if object.right==1
		object.angle-=2
	endif
	if object.angle<0
		object.angle+=512
	endif
	object.angle&=511
	Sin(temp0,object.angle)
	temp0*=object.speed
	temp0>>=9
	object.xpos+=temp0
	Cos(temp0,object.angle)
	temp0*=object.speed
	temp0>>=9
	Object.Value0+=temp0
end function


function Sonic_ProcessAnimationSpeed
	Object.Value3+=Object.AnimationSpeed
	if Object.Value3>239
		Object.Value3-=240
		Object.Frame++
		if Object.Frame>Object.Value2
			Object.Frame=Object.Value1
		endif
	endif
end function


event ObjectMain
	if Object[4].Value5>0
		Object[4].Value5--
	endif
	switch Object.State
	case 0
		CallFunction(Sonic_ProcessAnimationSpeed)
		Object.Value6++
		if Object.Value6==120
			Object.Value6=0
			Object.State=1
			Object.Frame=2
			Object.Value1=4
			Object.Value2=4
			Object.Value3=0
			Object.AnimationSpeed=20
		endif
		break
	case 1
		CallFunction(Sonic_ProcessAnimationSpeed)
		Object.Value6++
		if Object.Value6==140
			Object.Value6=0
			Object.State=2
			Object.Frame=9
			Object.Value1=9
			Object.Value2=14
			object.speed=0
		endif
		break
	case 2
		CallFunction(Sonic_ProcessPlayer)
		if object.up == 1
			object.speed+=2048
			if object.speed>327680
				object.speed=327680
			endif
		end if
		if object.down==1
			object.speed-=3072
			if object.speed<0
				object.speed=0
			endif
		endif
		Object.AnimationSpeed=object.speed
		Object.AnimationSpeed*=15
		Object.AnimationSpeed/=81920
		Object.AnimationSpeed+=20
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		if Object.Value6>0
			Object.Value6--
			//object.xpos+=Player.ScreenXPos
			//Object.Value0+=Player.ScreenYPos
		endif
		if object.jumpPress==1
			Object.State=3
			Object.Value6=0
			Object.Frame=39
			Object.Value1=39
			Object.Value2=42
			Object.Value3=0
			Object.AnimationSpeed=80
			object.yvel=286720
			PlaySfx(0,0)
		endif
		break
	case 3
		CallFunction(Sonic_ProcessPlayer)
		if object.up == 1
			object.speed+=2048
			if object.speed>327680
				object.speed=327680
			endif
		end if
		if object.down==1
			object.speed-=3072
			if object.speed<0
				object.speed=0
			endif
		endif
		if object.jumpHold==0
			if object.yvel>172032
				object.yvel=172032
			endif
		endif
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		object.yvel-=8192
		object.ypos+=object.yvel
		if object.ypos<0
			object.ypos=0
			if Object[4].Value0>0
				if Object[4].Value5==0
					Object.State=2
					Object.Frame=9
					Object.Value1=9
					Object.Value2=14
					Object.Value3=0
				else
					Object.State=7
					Object.Frame=77
					Object.Value1=77
					Object.Value2=80
					Object.AnimationSpeed=80
					Object.Value3=0
				endif
			else
				object.controlMode=-1
				Object.State=8
				Stage.TimeEnabled=0
			endif
		endif
		break
	case 4
		CallFunction(Sonic_ProcessPlayer)
		if object.up == 1
			object.speed+=2048
			if object.speed>327680
				object.speed=327680
			endif
		end if
		if object.down==1
			object.speed-=3072
			if object.speed<0
				object.speed=0
			endif
		endif
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		if Object.Value6>0
			Object.Value6--
			//object.xpos+=Player.ScreenXPos
			//Object.Value0+=Player.ScreenYPos
		else
			if Object[4].Value5==0
				Object.State=2
				Object.Frame=9
				Object.Value1=9
				Object.Value2=14
				Object.Value3=0
			else
				Object.State=7
				Object.Frame=77
				Object.Value1=77
				Object.Value2=80
				Object.AnimationSpeed=80
				Object.Value3=0
			endif
		endif
		if object.jumpPress==1
			Object.State=3
			Object.Value6=0
			Object.Frame=39
			Object.Value1=39
			Object.Value2=42
			Object.AnimationSpeed=80
			object.yvel=286720
			PlaySfx(0,0)
		endif
		break
	case 5
		CallFunction(Sonic_ProcessPlayer)
		if object.up == 1
			object.speed+=2048
			if object.speed>327680
				object.speed=327680
			endif
		end if
		if object.down==1
			object.speed-=3072
			if object.speed<0
				object.speed=0
			endif
		endif
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		object.yvel-=2048
		object.ypos+=object.yvel
		if object.ypos<0
			object.ypos=0
			if Object[4].Value0>0
				if Object[4].Value5==0
					Object.State=2
					Object.Frame=9
					Object.Value1=9
					Object.Value2=14
					Object.Value3=0
				else
					Object.State=7
					Object.Frame=77
					Object.Value1=77
					Object.Value2=80
					Object.AnimationSpeed=80
					Object.Value3=0
				endif
			else
				Object.State=8
				object.controlMode=-1
				Stage.TimeEnabled=0
			endif
		endif
		break
	case 6
		CallFunction(Sonic_HandlePause)
		inputDown.left=0
		inputDown.right=0
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		temp0=object.xpos
		temp0>>=16
		temp1=Object.Value0
		temp1>>=16
		Get16x16TileInfo(CheckResult,temp0,temp1,6)
		if CheckResult==3
			Object.State=2
			Object.Frame=9
			Object.Value1=9
			Object.Value2=14
			Object.Value3=0
		endif
		if Object.Value6>0
			Object.Value6--
		else
			if Object[4].Value5==0
				Object.State=2
				Object.Frame=9
				Object.Value1=9
				Object.Value2=14
				Object.Value3=0
			else
				Object.State=7
				Object.Frame=77
				Object.Value1=77
				Object.Value2=80
				Object.AnimationSpeed=80
				Object.Value3=0
			endif
		endif
		break
	case 7
		CallFunction(Sonic_ProcessPlayer)
		if object.up == 1
			object.speed+=2048
			if object.speed>327680
				object.speed=327680
			endif
		end if
		if object.down==1
			object.speed-=3072
			if object.speed<0
				object.speed=0
			endif
		endif
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		if Object.Value6>0
			Object.Value6--
			//object.xpos+=Player.ScreenXPos
			//Object.Value0+=Player.ScreenYPos
		endif
		if object.jumpPress==1
			Object.State=3
			Object.Value6=0
			Object.Frame=39
			Object.Value1=39
			Object.Value2=42
			Object.Value3=0
			Object.AnimationSpeed=80
			object.yvel=286720
			PlaySfx(0,0)
		endif
		if Object[4].Value5==0
			Object.State=2
			Object.Frame=9
			Object.Value1=9
			Object.Value2=14
			Object.Value3=0
		endif
		break
	case 8
		Object.Frame=1
		Object.Value6=0
		object.speed=0
		break
	case 9
		if Object.Value6<128
			Object.Value6++
			object.angle-=2
			if object.angle<0
				object.angle+=512
			endif
		else
			if Object[3].Type==TypeName[BlankObject]
				ResetObjectEntity(3,TypeName[TimeStone],0,0,-1572864)
				Object[3].iXPos=screen.xcenter
				Object[3].Priority=1
			endif
		endif
		Object.Frame=Object.Value6
		Object.Frame>>=4
		Object.Frame+=81
		break
	case 10
		if Object.Value6==308
			Object[30].Type=TypeName[StageFinish]
			Object[30].PropertyValue=1
		else
			Object.Value6++
		endif
		break
	case 11
		CallFunction(Sonic_ProcessPlayer)
		if object.speed<327680
			object.speed+=2048
		endif
		if inputDown.down==1
			object.speed-=3072
			if object.speed<122880
				object.speed=122880
			endif
		endif
		CallFunction(Sonic_HandlePlayerTilt)
		CallFunction(Sonic_ProcessAnimationSpeed)
		object.yvel-=8192
		object.ypos+=object.yvel
		if object.ypos<0
			object.ypos=0
			if Object[4].Value0>0
				if Object[4].Value5==0
					Object.State=2
					Object.Frame=9
					Object.Value1=9
					Object.Value2=14
					Object.Value3=0
				else
					Object.State=7
					Object.Frame=77
					Object.Value1=77
					Object.Value2=80
					Object.AnimationSpeed=80
					Object.Value3=0
				endif
			else
				object.controlMode=-1
				Object.State=8
			endif
		endif
		break
	endswitch
	if object.xpos>0x7F80000
		object.xpos=0x7F80000
	endif
	if object.xpos<0
		object.xpos=0
	endif
	if Object.Value0>0x7F80000
		Object.Value0=0x7F80000
	endif
	if Object.Value0<0
		Object.Value0=0
	endif
	TileLayer[0].Angle=object.angle
	Sin(TileLayer[0].XPos,TileLayer[0].Angle)
	Cos(TileLayer[0].ZPos,TileLayer[0].Angle)
	TileLayer[0].XPos*=-11264
	TileLayer[0].ZPos*=-11264
	TileLayer[0].XPos+=object.xpos
	TileLayer[0].ZPos+=Object.Value0
	TileLayer[0].YPos=object.ypos
	TileLayer[0].YPos/=3
	TileLayer[0].YPos+=5767168
end event


event ObjectDraw
	temp0=TileLayer[0].YPos
	temp0>>=8
	temp0*=96
	temp0/=22528
	temp0+=128
	DrawSpriteScreenXY(0,screen.xcenter,temp0)
	temp0=TileLayer[0].YPos
	temp0-=object.ypos
	temp0>>=8
	temp0*=96
	temp0/=22528
	temp0+=128
	switch Object.State
	default
		DrawSpriteScreenXY(Object.Frame,screen.xcenter,temp0)
		break
	case 2
		temp1=Object.Frame
		temp2=Player.Tilt
		temp2>>=2
		temp2+=2
		switch temp2
		case 0
			temp1+=6
			Object.Direction=FACING_LEFT
			break
		case 1
			temp1+=12
			Object.Direction=FACING_LEFT
			break
		case 2
			Object.Direction=FACING_RIGHT
			break
		case 3
			temp1+=18
			Object.Direction=FACING_RIGHT
			break
		case 4
			temp1+=24
			Object.Direction=FACING_RIGHT
			break
		endswitch
		DrawSpriteScreenFX(temp1,FX_FLIP,screen.xcenter,temp0)
		break
	endswitch
end event


event ObjectStartup
	if Stage.PlayerListPos==0
		LoadSpriteSheet("Special/Sonic.gif")
	else
		LoadSpriteSheet("Special/Tails.gif")
	endif
	Object[2].Type=TypeName[Player Object]
	Object[2].Priority=1
	Object[2].Value5=22528
	Object[2].Frame=5
	Object[2].Value1=5
	Object[2].Value2=8
	Object[2].AnimationSpeed=30
	Object[2].drawOrder=5
	Object[2].xpos=0x3FC0000
	Object[2].value0=0x3FC0000
	SpriteFrame(-20,-4,40,8,210,377)
	SpriteFrame(-20,-48,40,48,1,197)
	SpriteFrame(-20,-48,40,48,83,197)
	SpriteFrame(-20,-48,40,48,42,197)
	SpriteFrame(-20,-48,40,48,1,197)
	SpriteFrame(-20,-48,40,48,1,246)
	SpriteFrame(-20,-48,40,48,42,246)
	SpriteFrame(-20,-48,40,48,83,246)
	SpriteFrame(-20,-48,40,48,42,246)
	SpriteFrame(-20,-48,40,48,1,1)
	SpriteFrame(-20,-48,40,48,42,1)
	SpriteFrame(-20,-48,40,48,83,1)
	SpriteFrame(-20,-48,40,48,1,50)
	SpriteFrame(-20,-48,40,48,42,50)
	SpriteFrame(-20,-48,40,48,83,50)
	SpriteFrame(-20,-48,40,48,1,99)
	SpriteFrame(-20,-48,40,48,42,99)
	SpriteFrame(-20,-48,40,48,83,99)
	SpriteFrame(-20,-48,40,48,1,148)
	SpriteFrame(-20,-48,40,48,42,148)
	SpriteFrame(-20,-48,40,48,83,148)
	SpriteFrame(-20,-48,40,48,124,1)
	SpriteFrame(-20,-48,40,48,165,1)
	SpriteFrame(-20,-48,40,48,206,1)
	SpriteFrame(-20,-48,40,48,124,50)
	SpriteFrame(-20,-48,40,48,165,50)
	SpriteFrame(-20,-48,40,48,206,50)
	SpriteFrame(-20,-48,40,48,124,50)
	SpriteFrame(-20,-48,40,48,165,50)
	SpriteFrame(-20,-48,40,48,206,50)
	SpriteFrame(-20,-48,40,48,124,1)
	SpriteFrame(-20,-48,40,48,165,1)
	SpriteFrame(-20,-48,40,48,206,1)
	SpriteFrame(-20,-48,40,48,1,148)
	SpriteFrame(-20,-48,40,48,42,148)
	SpriteFrame(-20,-48,40,48,83,148)
	SpriteFrame(-20,-48,40,48,1,99)
	SpriteFrame(-20,-48,40,48,42,99)
	SpriteFrame(-20,-48,40,48,83,99)
	SpriteFrame(-20,-40,40,40,165,99)
	SpriteFrame(-20,-40,40,40,206,99)
	SpriteFrame(-20,-40,40,40,124,140)
	SpriteFrame(-20,-40,40,40,124,99)
	SpriteFrame(-20,-48,40,48,51,344)
	SpriteFrame(-21,-48,42,48,182,295)
	SpriteFrame(-25,-48,49,48,1,344)
	if Stage.PlayerListPos==0
		SpriteFrame(-21,-48,42,48,135,410)
		SpriteFrame(-20,-48,40,48,178,410)
	else
		SpriteFrame(-21,-48,42,48,135,426)
		SpriteFrame(-20,-48,40,48,178,426)
	endif
	SpriteFrame(-16,-32,54,32,17,442)
	SpriteFrame(-26,-32,52,32,78,442)
	SpriteFrame(-37,-32,54,32,178,475)
	SpriteFrame(-32,-32,48,32,1,475)
	SpriteFrame(-30,-32,60,32,115,475)
	SpriteFrame(-16,-32,48,32,208,344)
	SpriteFrame(-28,-48,56,48,92,344)
	SpriteFrame(-30,-32,60,32,54,475)
	if Stage.PlayerListPos==0
		SpriteFrame(-29,-32,58,32,149,344)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
		SpriteFrame(-30,-32,60,32,149,377)
	else
		SpriteFrame(-29,-32,58,37,149,344)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
		SpriteFrame(-30,-32,60,32,149,382)
	endif
	SpriteFrame(-20,-48,40,48,1,393)
	SpriteFrame(-20,-48,40,48,42,393)
	SpriteFrame(-20,-48,40,48,83,393)
	SpriteFrame(-20,-48,40,48,165,140)
	SpriteFrame(-20,-48,40,48,206,140)
	SpriteFrame(-20,-48,40,48,165,189)
	SpriteFrame(-20,-48,40,48,206,189)
	SpriteFrame(-20,-48,40,48,1,197)
	SpriteFrame(-20,-48,40,48,124,246)
	SpriteFrame(-20,-48,40,48,165,246)
	SpriteFrame(-20,-48,40,48,206,246)
	SpriteFrame(-20,-48,40,48,1,295)
	SpriteFrame(-20,-48,40,48,42,295)
	SpriteFrame(-16,-48,32,48,83,295)
	SpriteFrame(-16,-48,32,48,116,295)
	SpriteFrame(-16,-48,32,48,116,295)
	SpriteFrame(-16,-48,32,48,149,295)
end event
