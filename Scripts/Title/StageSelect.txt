// ----------------------------------
// RSDK Project: Sonic 1/Sonic 2
// Script Description: Sega Object
// Script Author: Christian Whitehead/Simon Thomley
// Unpacked by Rubberduckycooly's script unpacker
// ----------------------------------

// Aliases

private alias object.value1 : KEH.menusel
private alias object.value2 : KEH.scroll

private alias object.value3 : KEH.scrollPosPrev
private alias object.value4 : KEH.scrollPosTarget
private alias object.value5 : KEH.scrollAngle

private alias 0  : KEH_MIN
private alias 15 : KEH_MAX

private alias 72 : KEH_STAGEROWSIZE

reserve function scrolling
reserve function Sega_Background


function scrolling
	// Move the camera to the target
	if KEH.scrollPosPrev != KEH.scrollPosTarget
		Sin(temp7, KEH.scrollAngle)
		
		temp7 >>= 2
		
		if temp7 > KEH_STAGEROWSIZE
			temp7 = KEH_STAGEROWSIZE
		end if
		
		temp1 -= KEH.scrollPosPrev
		
		if KEH.scrollPosPrev > KEH.scrollPosTarget
			temp1 += temp7
		else
			temp1 -= temp7
		end if
	else
		temp1 -= KEH.scrollPosTarget
	end if
end function

function Sega_Background
	//Background
	object.value22++
	object.value22 %= 1
	if object.value22 == 0
		object.value21++
		object.value21 %= 128
	end if

	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop

	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 += 128
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop

	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 -= 128
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop
	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 -= 256
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop

	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 += 256
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop

	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 += 384
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop
	temp0 = object.value21
	temp1 = object.value21
	temp1 -= 10000
	temp1 += 512
	while temp1 < 999
		while temp0 < screen.ysize
			DrawSpriteScreenXY(2, temp1, temp0)
			temp0 += 32
			temp1 += 32
		loop
	//temp0 = object.value21

	temp0 -= 10000
	loop
end function


event ObjectMain
	switch object.state
	case 0
		object.inkEffect = INK_ALPHA
		object.value0 = 320
		SetActivePalette(5, 0, screen.ysize)
		SetScreenFade(0, 0, 0, object.value0)
		KEH.menusel = saveRAM[251]
		
		KEH.scrollPosTarget = KEH.menusel
		KEH.scrollPosTarget *= KEH_STAGEROWSIZE
		KEH.scrollPosPrev = KEH.scrollPosTarget
		
		KEH.scrollAngle = 0
		object.state++
		break

	case 1
		if object.value0 > 0
			object.value0 -= 8
		else
			PlayMusic(2)
			object.state++
		end if

		SetScreenFade(0, 0, 0, object.value0)
		break
		
	case 2
		if inputPress.buttonB == 1				
			object.state = 6
			return
		end if
		
		// Move the camera to the target
		if KEH.scrollAngle < 127
			KEH.scrollAngle += 8
			if KEH.scrollAngle > 127
				KEH.scrollAngle = 127
				KEH.scrollPosPrev = KEH.scrollPosTarget
			end if
		end if
		
		if KEH.scrollPosPrev != KEH.scrollPosTarget
			return
		end if
		
		if inputPress.up == true
			if KEH.menusel > KEH_MIN
				KEH.menusel--
				
				KEH.scrollAngle = 0
				
				temp0 = KEH_MAX
				temp0 -= 2
				
				CheckLower(KEH.menusel, temp0)
				checkResult *= 72
				KEH.scrollPosTarget -= checkResult
				
				PlaySfx(SfxName[Score Add], 0)
			end if
		end if
		
		if inputPress.down == true		
			if KEH.menusel < KEH_MAX
				KEH.menusel++
				
				KEH.scrollAngle = 0
				
				CheckLower(KEH.scrollPosTarget, 936)
				temp0 = checkResult
				CheckLower(KEH.menusel, KEH_MAX)
				temp0 &= checkResult
				temp0 *= 72
				KEH.scrollPosTarget += temp0
				
				PlaySfx(SfxName[Score Add], 0)
			end if
		end if
		
		if inputPress.start == true	
			if KEH.menusel == 13
				PlaySfx(SfxName[Fail], 0)
			else
				object.state = 5
				saveRAM[251] = KEH.menusel
			end if
		end if
		break

	case 5
		if KEH.menusel == 9
			stage.activeList = BONUS_STAGE
			stage.listPos = 0
		else
			stage.activeList = REGULAR_STAGE
			stage.listPos = KEH.menusel
		end if
		stage.playerListPos = saveRAM[202]
		if object.value0 < 256
			object.value0 += 8
			music.volume -= 2
			SetScreenFade(0, 0, 0, object.value0)
		else
			LoadStage()
			StopMusic()
			SetScreenFade(0, 0, 0, 0xFF)
		end if	
		break
	case 6
		stage.listPos = 0
		if object.value0 < 256
			object.value0 += 8
			music.volume -= 2
			SetScreenFade(0, 0, 0, object.value0)
		else
			LoadStage()
			StopMusic()
			SetScreenFade(0, 0, 0, 0xFF)
		end if	
		break
	end switch
end event


event ObjectDraw
	CallFunction(Sega_Background)

	// Select Stage Header
	temp1 = 16
	CallFunction(scrolling)
	DrawSpriteScreenXY(1, screen.xcenter, temp1)

	//Add stages
	temp1 = 32
	temp0 = 0
	CallFunction(scrolling)
	while temp0 < 16
		DrawSpriteScreenXY(0, screen.xcenter, temp1)
		temp1 += KEH_STAGEROWSIZE
		temp0++
	loop
	
	//Selector
	temp1 = 32
	temp0 = 0
	while temp0 < KEH.menusel
		temp1 += KEH_STAGEROWSIZE
		temp0++
	loop
	
	temp1 = 32
	CallFunction(scrolling)
	temp0 = KEH.menusel
	temp0 *= KEH_STAGEROWSIZE
	temp1 += temp0
	DrawSpriteScreenXY(3, screen.xcenter, temp1)

	//Numbers	
	temp0 = 0
	temp1 = 32
	CallFunction(scrolling)
	temp2 = screen.xcenter
	temp2 += 3
	while temp0 < 16
		arrayPos1 = 300
		arrayPos1 *= temp0

		temp1 += 25
		DrawNumbers(40, temp2, temp1, saveRAM[arrayPos1], 6, 8, 0) // Score

		arrayPos1++
		temp1 += 16
		DrawNumbers(40, temp2, temp1, saveRAM[arrayPos1], 3, 8, 0) // Rings

		arrayPos1++
		temp1 -= 34	
		temp2 += 128
		DrawNumbers(40, temp2, temp1, saveRAM[arrayPos1], 3, 8, 0) // Play Count

		arrayPos1++

		object.value10 = saveRAM[arrayPos1]
		object.value11 = 0
		object.value12 = 0
		while object.value10 >= 6000
			object.value12++
			object.value10 -= 6000
		loop
		
		while object.value10 >= 100
			object.value11++
			object.value10 -= 100
		loop

		if saveRAM[arrayPos1] == 0
			saveRAM[arrayPos1] = 59999
		end if

		temp1 += 12
		DrawSpriteScreenXY(50, temp2, temp1)
		DrawNumbers(40, temp2, temp1, object.value10, 2, 8, 1) // Milliseconds

		temp2 -= 27
		DrawNumbers(40, temp2, temp1, object.value11, 2, 8, 1) // Seconds

		temp2 -= 23
		DrawNumbers(40, temp2, temp1, object.value12, 2, 8, 0) // Minutes

		arrayPos1++
		temp2 += 27	
		temp2 += 23	
		temp1 += 12
		DrawNumbers(40, temp2, temp1, saveRAM[arrayPos1], 3, 7, 0) // Deaths

		arrayPos1++
		temp1 += 12
		DrawSpriteScreenXY(51, temp2, temp1) // Rank

		temp2 -= 128
		temp1 += 29
		temp0++
	loop

	// Stage Names
	temp0 = 0
	temp1 = 48
	temp2 = 16
	temp3 = screen.xcenter
	temp3 -= 141
	CallFunction(scrolling)
	while temp0 < 10
		DrawSpriteScreenXY(temp2, temp3, temp1)
		temp1 += KEH_STAGEROWSIZE
		temp2++
		temp0++
	loop
	
	temp0 = 0
	temp1 = 624
	temp2 = 32
	temp3 = screen.xcenter
	temp3 -= 141
	CallFunction(scrolling)
	while temp0 < 8
		DrawSpriteScreenXY(temp2, temp3, temp1)
		temp1 += KEH_STAGEROWSIZE
		temp2++
		temp0++
	loop

	// Stage Icons
	temp0 = 0
	temp1 = 48
	CallFunction(scrolling)
	temp2 = 4
	while temp0 < 10
		DrawSpriteScreenXY(temp2, temp3, temp1)
		temp1 += KEH_STAGEROWSIZE
		temp2++
		temp0++
	loop
	
	temp0 = 0
	temp1 = 624
	CallFunction(scrolling)
	temp2 = 26
	while temp0 < 8
		DrawSpriteScreenXY(temp2, temp3, temp1)
		temp1 += KEH_STAGEROWSIZE
		temp2++
		temp0++
	loop
end event


event ObjectStartup
	LoadSpriteSheet("KEHMenu/StageSelect.gif")
	SpriteFrame(-149, 0, 298, 58, 1, 130) // 0 - Stage box (incl. texts), Highlighted
	SpriteFrame(-71, 0, 142, 7, 33, 1)    // 1 - "Select a Stage"
	SpriteFrame(0, 0, 32, 128, 0, 1)      // 2 - Background strip
	SpriteFrame(-149, 0, 298, 58, 1, 372) // 3 - Stage box (incl. texts), Unhighlighted
	
	temp0 = 0
	temp1 = 33
	while temp0 < 8
		SpriteFrame(0, 0, 32, 24, temp1, 9) // 4-12 - S2 Stage Icons
		temp1 += 33
		temp0++
	loop
	
	temp0 = 0
	temp1 = 33
	while temp0 < 2
		SpriteFrame(0, 0, 32, 24, temp1, 34) // 13 and 14 - WFZ + HPZ Icons
		temp1 += 33
		temp0++
	loop
	
	SpriteFrame(0, 0, 32, 25, 66, 59) // 15 - X Stage Icon
	SpriteFrame(0, 0, 32, 25, 66, 59) // 16 - X Stage Icon (filler)
	
	temp0 = 0
	temp1 = 34
	while temp0 < 10
		SpriteFrame(40, -7, 112, 7, 99, temp1)//16-26 - S2 Stage Names
		temp1 += 8
		temp0++
	loop
	
	SpriteFrame(40, -7, 112, 7, 99, 122) // 27 - filler
	SpriteFrame(40, -7, 112, 7, 99, 122) // 28 - filler
	
	temp0 = 0
	temp1 = 1
	while temp0 < 6
		SpriteFrame(0, 0, 32, 24, temp1, 431) //28-34 - S1 Stage Icons
		temp1 += 33
		temp0++
	loop
	
	temp0 = 0
	temp1 = 456
	while temp0 < 6
		SpriteFrame(40, -7, 88, 7, 1, temp1) //35-41 - S1 Stage Names
		temp1 += 8
		temp0++
	loop
	
	temp0 = 0
	temp1 = 99
	while temp0 < 10
		SpriteFrame(0, 0, 8, 7, temp1, 114)//40-49 - Numbers
		temp1 += 8
		temp0++
	loop

	SpriteFrame(-58, 0, 64, 7, 33, 119) // 50 ' "
	SpriteFrame(0, 0, 8, 7, 139, 34) // 51 L

	options.touchControls = false
	SetMusicTrack("2D.ogg", 2, 108000)
	stage.debugmode = 0
	LoadPalette("StageSelect.act", 5, 0, 0, 256)
end event

event RSDKDraw
	DrawSprite(0)
end event

event RSDKLoad
	LoadSpriteSheet("Title/Title.gif")
	SpriteFrame(-93, -29, 188, 58, 323, 242)
end event